<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>flexsdm: Overview of Post-modeling functions • flexsdm</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/united/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="flexsdm: Overview of Post-modeling functions">
<meta property="og:description" content="flexsdm">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">flexsdm</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01_pre_modeling.html">1. Overview of Pre-modeling functions</a>
    </li>
    <li>
      <a href="../articles/02_modeling.html">2. Overview of Modeling functions</a>
    </li>
    <li>
      <a href="../articles/03_post_modeling.html">3. Overview of Post-modeling functions</a>
    </li>
    <li>
      <a href="../articles/04_Red_fir_example.html">4. An example with Red Fir</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/sjevelazco/flexsdm/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="03_post_modeling_files/header-attrs-2.11/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>flexsdm: Overview of Post-modeling functions</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/sjevelazco/flexsdm/blob/master/vignettes/03_post_modeling.Rmd"><code>vignettes/03_post_modeling.Rmd</code></a></small>
      <div class="hidden name"><code>03_post_modeling.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>Species distribution modeling (SDM) has become a standard tool in multiple research areas, including ecology, conservation biology, biogeography, paleobiogeography, and epidemiology. SDM is an area of active theoretical and methodological research The <em>flexsdm</em> package provides users the ability to manipulate and parameterize models in a variety of ways that meet their unique research needs.</p>
<p>This flexibility enables users to define their own complete or partial modeling procedure specific for their modeling situations (e.g., number of variables, number of records, different algorithms and ensemble methods, algorithms tuning, etc.).</p>
<p>In this vignette, users will learn about the post-modeling set of functions in the <em>flexsdm</em> package. These functions were designed with the aim of assisting the flexsdm user in predicting, evaluating, and correcting SDMs.</p>
<p>These are the functions created for model prediction, evaluation and correction:</p>
<p><strong>Post-modeling functions</strong></p>
<ul>
<li><p>sdm_predict() Spatial predictions from individual and ensemble models</p></li>
<li><p>sdm_summarize() Merge model performance tables</p></li>
<li><p>interp() Raster interpolation between SDM predictions to two time periods</p></li>
<li><p>extra_eval() Measure model extrapolation</p></li>
<li><p>extra_correct() Constraint suitability values under a given extrapolation value</p></li>
<li><p>msdm_priori() Create spatial predictor variables to reduce overprediction from species distribution models</p></li>
<li><p>msdm_posteriori() Methods to correct overprediction of species distribution models based on occurrences and suitability patterns</p></li>
</ul>
</div>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>Install the flexsdm package. You can install the released version of <em>flexsdm</em> from <a href="https://github.com/sjevelazco/flexsdm">github</a> with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># devtools::install_github('sjevelazco/flexsdm')</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">flexsdm</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'dplyr'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/terra/">terra</a></span><span class="op">)</span>
<span class="co">#&gt; terra version 1.4.11</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'terra'</span>
<span class="co">#&gt; The following object is masked from 'package:dplyr':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     src</span>
<span class="co">#&gt; The following object is masked from 'package:knitr':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     spin</span></code></pre></div>
</div>
<div id="project-directory-setup" class="section level2">
<h2 class="hasAnchor">
<a href="#project-directory-setup" class="anchor"></a>Project directory setup</h2>
<p>Decide where on your computer you would like to store the inputs and outputs of your project (this will be your main directory). Use an existing one or use dir.create() to create your main directory. Then specify whether or not to include folders for projections, calibration areas, algorithms, ensembles, and thresholds. For more details see <a href="https://sjevelazco.github.io/flexsdm/articles/01_pre_modeling.html">Vignette 01_pre_modeling</a></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_project</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"flex_sdm_project"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="va">my_project</span><span class="op">)</span>

<span class="va">project_directory</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdm_directory.html">sdm_directory</a></span><span class="op">(</span>
  main_dir <span class="op">=</span> <span class="va">my_project</span>,
  projections <span class="op">=</span> <span class="cn">NULL</span>,
  calibration_area <span class="op">=</span> <span class="cn">TRUE</span>,
  algorithm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"fit_glm"</span>, <span class="st">"fit_raf"</span>, <span class="st">"fit_gbm"</span><span class="op">)</span>,
  ensemble <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"mean"</span><span class="op">)</span>,
  threshold <span class="op">=</span> <span class="cn">TRUE</span>,
  return_vector <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span>
<span class="co">#&gt; Directories were be created in:</span>
<span class="co">#&gt; C:\Users\santi\AppData\Local\Temp\RtmpMntrDC/flex_sdm_project</span></code></pre></div>
</div>
<div id="species-occurrence-presenceabsense-and-environmental-data" class="section level2">
<h2 class="hasAnchor">
<a href="#species-occurrence-presenceabsense-and-environmental-data" class="anchor"></a>Species occurrence, presence/absense and environmental data</h2>
<p>In this tutorial, we will be using the “spp” example dataset which includes pr_ab (presence = 1, and absence = 0), location (x, y) data for 3 plant species found in California and a raster with environmental data. You can load these data into your local R environment by using the code below:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"spp"</span><span class="op">)</span>
<span class="va">somevar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"external/somevar.tif"</span>, package <span class="op">=</span> <span class="st">"flexsdm"</span><span class="op">)</span>
<span class="va">somevar</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="va">somevar</span><span class="op">)</span></code></pre></div>
<p>If you want to replace the spp dataset with your own data, make sure that contains coordinates, species presence = 1 / absence = 0 and a raster with environmental data.</p>
<p>First, prepare the occurrences, environmental conditions and partitions</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Select only one species</span>
<span class="va">some_sp</span> <span class="op">&lt;-</span> <span class="va">spp</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="st">"sp3"</span><span class="op">)</span>

<span class="co"># Extract the environmental condition from the rsater for sp3</span>
<span class="va">some_sp</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="../reference/sdm_extract.html">sdm_extract</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">some_sp</span>,
    x <span class="op">=</span> <span class="st">"x"</span>,
    y <span class="op">=</span> <span class="st">"y"</span>,
    env_layer <span class="op">=</span> <span class="va">somevar</span>
  <span class="op">)</span>
<span class="co">#&gt; 4 rows were excluded from database because NAs were found</span>

<span class="co"># Make a partition defining the method, folds and replicates</span>
<span class="va">some_sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/part_random.html">part_random</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">some_sp</span>,
  pr_ab <span class="op">=</span> <span class="st">"pr_ab"</span>,
  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"rep_kfold"</span>, folds <span class="op">=</span> <span class="fl">3</span>, replicates <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Next, fit different models</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Fit and validate a [generalized linear model](https://sjevelazco.github.io/flexsdm/reference/fit_glm.html)</span>
<span class="va">mglm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_glm.html">fit_glm</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">some_sp</span>,
  response <span class="op">=</span> <span class="st">"pr_ab"</span>,
  predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"CFP_1"</span>, <span class="st">"CFP_2"</span>, <span class="st">"CFP_3"</span>, <span class="st">"CFP_4"</span><span class="op">)</span>,
  partition <span class="op">=</span> <span class="st">".part"</span>,
  poly <span class="op">=</span> <span class="fl">2</span>
<span class="op">)</span>
<span class="co">#&gt; Formula used for model fitting:</span>
<span class="co">#&gt; pr_ab ~ CFP_1 + CFP_2 + CFP_3 + CFP_4 + I(CFP_1^2) + I(CFP_2^2) + I(CFP_3^2) + I(CFP_4^2)</span>
<span class="co">#&gt; Replica number: 1/5</span>
<span class="co">#&gt; Partition number: 1/3</span>
<span class="co">#&gt; Partition number: 2/3</span>
<span class="co">#&gt; Partition number: 3/3</span>
<span class="co">#&gt; Replica number: 2/5</span>
<span class="co">#&gt; Partition number: 1/3</span>
<span class="co">#&gt; Partition number: 2/3</span>
<span class="co">#&gt; Partition number: 3/3</span>
<span class="co">#&gt; Replica number: 3/5</span>
<span class="co">#&gt; Partition number: 1/3</span>
<span class="co">#&gt; Partition number: 2/3</span>
<span class="co">#&gt; Partition number: 3/3</span>
<span class="co">#&gt; Replica number: 4/5</span>
<span class="co">#&gt; Partition number: 1/3</span>
<span class="co">#&gt; Partition number: 2/3</span>
<span class="co">#&gt; Partition number: 3/3</span>
<span class="co">#&gt; Replica number: 5/5</span>
<span class="co">#&gt; Partition number: 1/3</span>
<span class="co">#&gt; Partition number: 2/3</span>
<span class="co">#&gt; Partition number: 3/3</span>

<span class="co"># Fit and validate a [random forest model](https://sjevelazco.github.io/flexsdm/reference/fit_raf.html)</span>
<span class="va">mraf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_raf.html">fit_raf</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">some_sp</span>,
  response <span class="op">=</span> <span class="st">"pr_ab"</span>,
  predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"CFP_1"</span>, <span class="st">"CFP_2"</span>, <span class="st">"CFP_3"</span>, <span class="st">"CFP_4"</span><span class="op">)</span>,
  partition <span class="op">=</span> <span class="st">".part"</span>,
<span class="op">)</span>
<span class="co">#&gt; Formula used for model fitting:</span>
<span class="co">#&gt; pr_ab ~ CFP_1 + CFP_2 + CFP_3 + CFP_4</span>
<span class="co">#&gt; Replica number: 1/5</span>
<span class="co">#&gt; Partition number: 1/3</span>
<span class="co">#&gt; Partition number: 2/3</span>
<span class="co">#&gt; Partition number: 3/3</span>
<span class="co">#&gt; Replica number: 2/5</span>
<span class="co">#&gt; Partition number: 1/3</span>
<span class="co">#&gt; Partition number: 2/3</span>
<span class="co">#&gt; Partition number: 3/3</span>
<span class="co">#&gt; Replica number: 3/5</span>
<span class="co">#&gt; Partition number: 1/3</span>
<span class="co">#&gt; Partition number: 2/3</span>
<span class="co">#&gt; Partition number: 3/3</span>
<span class="co">#&gt; Replica number: 4/5</span>
<span class="co">#&gt; Partition number: 1/3</span>
<span class="co">#&gt; Partition number: 2/3</span>
<span class="co">#&gt; Partition number: 3/3</span>
<span class="co">#&gt; Replica number: 5/5</span>
<span class="co">#&gt; Partition number: 1/3</span>
<span class="co">#&gt; Partition number: 2/3</span>
<span class="co">#&gt; Partition number: 3/3</span>

<span class="co"># Fit and validate a [general boosted regression model](https://sjevelazco.github.io/flexsdm/reference/fit_gbm.html)</span>
<span class="va">mgbm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_gbm.html">fit_gbm</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">some_sp</span>,
  response <span class="op">=</span> <span class="st">"pr_ab"</span>,
  predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"CFP_1"</span>, <span class="st">"CFP_2"</span>, <span class="st">"CFP_3"</span>, <span class="st">"CFP_4"</span><span class="op">)</span>,
  partition <span class="op">=</span> <span class="st">".part"</span>
<span class="op">)</span>
<span class="co">#&gt; Formula used for model fitting:</span>
<span class="co">#&gt; pr_ab ~ CFP_1 + CFP_2 + CFP_3 + CFP_4</span>
<span class="co">#&gt; Replica number: 1/5</span>
<span class="co">#&gt; Partition number: 1/3</span>
<span class="co">#&gt; Partition number: 2/3</span>
<span class="co">#&gt; Partition number: 3/3</span>
<span class="co">#&gt; Replica number: 2/5</span>
<span class="co">#&gt; Partition number: 1/3</span>
<span class="co">#&gt; Partition number: 2/3</span>
<span class="co">#&gt; Partition number: 3/3</span>
<span class="co">#&gt; Replica number: 3/5</span>
<span class="co">#&gt; Partition number: 1/3</span>
<span class="co">#&gt; Partition number: 2/3</span>
<span class="co">#&gt; Partition number: 3/3</span>
<span class="co">#&gt; Replica number: 4/5</span>
<span class="co">#&gt; Partition number: 1/3</span>
<span class="co">#&gt; Partition number: 2/3</span>
<span class="co">#&gt; Partition number: 3/3</span>
<span class="co">#&gt; Replica number: 5/5</span>
<span class="co">#&gt; Partition number: 1/3</span>
<span class="co">#&gt; Partition number: 2/3</span>
<span class="co">#&gt; Partition number: 3/3</span></code></pre></div>
<div id="fit-and-ensemble-the-models-above" class="section level3">
<h3 class="hasAnchor">
<a href="#fit-and-ensemble-the-models-above" class="anchor"></a>1. Fit and ensemble the models above</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit and ensemble the models. To choose the arguments that best fit your own data, see all options available in [fit_ensemble](https://sjevelazco.github.io/flexsdm/reference/fit_ensemble.html)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>mensemble <span class="ot">&lt;-</span> <span class="fu">fit_ensemble</span>(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">models =</span> <span class="fu">list</span>(mglm, mraf, mgbm),</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">ens_method =</span> <span class="st">"meansup"</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">thr =</span> <span class="cn">NULL</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">thr_model =</span> <span class="st">"max_sens_spec"</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">metric =</span> <span class="st">"TSS"</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="sc">|</span>                                                                            </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="er">|</span>                                                                      <span class="er">|</span>   <span class="dv">0</span>%</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="sc">|</span>                                                                            </span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="er">|======================================================================|</span> <span class="dv">100</span>%</span></code></pre></div>
<p>You can also fit a model using an Ensembles of Small Models approach. In this example, we fit without threshold specification and with k-fold cross-validation.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>msmall <span class="ot">&lt;-</span> <span class="fu">esm_gam</span>(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> some_sp,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">response =</span> <span class="st">"pr_ab"</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">predictors =</span> <span class="fu">c</span>(<span class="st">"CFP_1"</span>, <span class="st">"CFP_2"</span>, <span class="st">"CFP_3"</span>, <span class="st">"CFP_4"</span>),</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">partition =</span> <span class="st">".part"</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">thr =</span> <span class="cn">NULL</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="sc">|</span>                                                                            </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="er">|</span>                                                                      <span class="er">|</span>   <span class="dv">0</span>%</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="sc">|</span>                                                                            </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="er">|============</span>                                                          <span class="er">|</span>  <span class="dv">17</span>%</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="sc">|</span>                                                                            </span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="er">|=======================</span>                                               <span class="er">|</span>  <span class="dv">33</span>%</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="sc">|</span>                                                                            </span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="er">|===================================</span>                                   <span class="er">|</span>  <span class="dv">50</span>%</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="sc">|</span>                                                                            </span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  <span class="er">|===============================================</span>                       <span class="er">|</span>  <span class="dv">67</span>%</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="sc">|</span>                                                                            </span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="er">|==========================================================</span>            <span class="er">|</span>  <span class="dv">83</span>%</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  <span class="sc">|</span>                                                                            </span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  <span class="er">|======================================================================|</span> <span class="dv">100</span>%</span></code></pre></div>
<p>Finally, we can predict different kinds of models from the same data (some_sp). <a href="https://sjevelazco.github.io/flexsdm/reference/sdm_predict.html">sdm_predict</a> can be used for predicting one or more models fitted with fit_ or tune_ functions. The output will be a list of SpatRaster with continuous and/or binary predictions.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Predict using a single model, which is an mglm model in this example,</span>
<span class="co"># and a threshold type for binary predictions</span>
<span class="va">ind_p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdm_predict.html">sdm_predict</a></span><span class="op">(</span>
  models <span class="op">=</span> <span class="va">mglm</span>,
  pred <span class="op">=</span> <span class="va">somevar</span>,
  thr <span class="op">=</span> <span class="st">"max_fpb"</span>,
  con_thr <span class="op">=</span> <span class="cn">FALSE</span>,
  predict_area <span class="op">=</span> <span class="cn">NULL</span>
<span class="op">)</span>
<span class="co">#&gt; Predicting individual models</span>

<span class="co"># Inspect the object. It's a SpatRaster with 2 layers: glm, max_fpb</span>
<span class="co"># These are the continuous and binary prediction from the model</span>
<span class="va">ind_p</span>
<span class="co">#&gt; $glm</span>
<span class="co">#&gt; class       : SpatRaster </span>
<span class="co">#&gt; dimensions  : 558, 394, 2  (nrow, ncol, nlyr)</span>
<span class="co">#&gt; resolution  : 1890, 1890  (x, y)</span>
<span class="co">#&gt; extent      : -373685.8, 370974.2, -604813.3, 449806.7  (xmin, xmax, ymin, ymax)</span>
<span class="co">#&gt; coord. ref. : +proj=aea +lat_0=0 +lon_0=-120 +lat_1=34 +lat_2=40.5 +x_0=0 +y_0=-4000000 +datum=NAD83 +units=m +no_defs </span>
<span class="co">#&gt; sources     : memory  </span>
<span class="co">#&gt;               memory  </span>
<span class="co">#&gt; names       :          glm,      max_fpb </span>
<span class="co">#&gt; min values  : 2.220446e-16, 0.000000e+00 </span>
<span class="co">#&gt; max values  :            1,            1</span>

<span class="co"># Plot to see this layers</span>
<span class="va">ind_p_rst</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="va">ind_p</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">ind_p_rst</span><span class="op">)</span></code></pre></div>
<p><img src="03_post_modeling_files/figure-html/sdm_predict-1.png" width="576"></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># Predict a list of more than one model, specifying a threshold type</span>
<span class="va">list_p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdm_predict.html">sdm_predict</a></span><span class="op">(</span>
  models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">mglm</span>, <span class="va">mraf</span>, <span class="va">mgbm</span><span class="op">)</span>,
  pred <span class="op">=</span> <span class="va">somevar</span>,
  thr <span class="op">=</span> <span class="st">"max_fpb"</span>,
  con_thr <span class="op">=</span> <span class="cn">FALSE</span>,
  predict_area <span class="op">=</span> <span class="cn">NULL</span>
<span class="op">)</span>
<span class="co">#&gt; Predicting list of individual models</span>

<span class="co"># Inspect the object. It's a list with 3 SpatRaster, one for each model,</span>
<span class="co"># each of which contains 2 layers, for the continuous and thresholded binary predictions.</span>
<span class="va">list_p</span>
<span class="co">#&gt; $glm</span>
<span class="co">#&gt; class       : SpatRaster </span>
<span class="co">#&gt; dimensions  : 558, 394, 2  (nrow, ncol, nlyr)</span>
<span class="co">#&gt; resolution  : 1890, 1890  (x, y)</span>
<span class="co">#&gt; extent      : -373685.8, 370974.2, -604813.3, 449806.7  (xmin, xmax, ymin, ymax)</span>
<span class="co">#&gt; coord. ref. : +proj=aea +lat_0=0 +lon_0=-120 +lat_1=34 +lat_2=40.5 +x_0=0 +y_0=-4000000 +datum=NAD83 +units=m +no_defs </span>
<span class="co">#&gt; sources     : memory  </span>
<span class="co">#&gt;               memory  </span>
<span class="co">#&gt; names       :          glm,      max_fpb </span>
<span class="co">#&gt; min values  : 2.220446e-16, 0.000000e+00 </span>
<span class="co">#&gt; max values  :            1,            1 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $raf</span>
<span class="co">#&gt; class       : SpatRaster </span>
<span class="co">#&gt; dimensions  : 558, 394, 2  (nrow, ncol, nlyr)</span>
<span class="co">#&gt; resolution  : 1890, 1890  (x, y)</span>
<span class="co">#&gt; extent      : -373685.8, 370974.2, -604813.3, 449806.7  (xmin, xmax, ymin, ymax)</span>
<span class="co">#&gt; coord. ref. : +proj=aea +lat_0=0 +lon_0=-120 +lat_1=34 +lat_2=40.5 +x_0=0 +y_0=-4000000 +datum=NAD83 +units=m +no_defs </span>
<span class="co">#&gt; sources     : memory  </span>
<span class="co">#&gt;               memory  </span>
<span class="co">#&gt; names       : raf, max_fpb </span>
<span class="co">#&gt; min values  :   0,       0 </span>
<span class="co">#&gt; max values  :   1,       1 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $gbm</span>
<span class="co">#&gt; class       : SpatRaster </span>
<span class="co">#&gt; dimensions  : 558, 394, 2  (nrow, ncol, nlyr)</span>
<span class="co">#&gt; resolution  : 1890, 1890  (x, y)</span>
<span class="co">#&gt; extent      : -373685.8, 370974.2, -604813.3, 449806.7  (xmin, xmax, ymin, ymax)</span>
<span class="co">#&gt; coord. ref. : +proj=aea +lat_0=0 +lon_0=-120 +lat_1=34 +lat_2=40.5 +x_0=0 +y_0=-4000000 +datum=NAD83 +units=m +no_defs </span>
<span class="co">#&gt; sources     : memory  </span>
<span class="co">#&gt;               memory  </span>
<span class="co">#&gt; names       :          gbm,      max_fpb </span>
<span class="co">#&gt; min values  : 0.0002949323, 0.0000000000 </span>
<span class="co">#&gt; max values  :    0.9986537,    1.0000000</span>

<span class="co"># Plot to see this layers</span>
<span class="va">list_p_rst</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="va">list_p</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">list_p_rst</span><span class="op">)</span></code></pre></div>
<p><img src="03_post_modeling_files/figure-html/sdm_predict-2.png" width="576"></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># Predict an ensemble model. This is only possible using one fit_ensemble object. It's not possible to include e.g., list(fit_ensemble1, fit_ensemble2) in the model argument.</span>
<span class="va">ensemble_p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdm_predict.html">sdm_predict</a></span><span class="op">(</span>
  models <span class="op">=</span> <span class="va">mensemble</span>,
  pred <span class="op">=</span> <span class="va">somevar</span>,
  thr <span class="op">=</span> <span class="st">"max_fpb"</span>,
  con_thr <span class="op">=</span> <span class="cn">FALSE</span>,
  predict_area <span class="op">=</span> <span class="cn">NULL</span>
<span class="op">)</span>
<span class="co">#&gt; Predicting ensembles</span>

<span class="co"># Inspect the object. It's a SpatRaster with 2 layers, mensemble and max_fpb</span>
<span class="co"># These are the continuous and binary prediction from the ensemble model</span>
<span class="va">ensemble_p</span>
<span class="co">#&gt; $meansup</span>
<span class="co">#&gt; class       : SpatRaster </span>
<span class="co">#&gt; dimensions  : 558, 394, 2  (nrow, ncol, nlyr)</span>
<span class="co">#&gt; resolution  : 1890, 1890  (x, y)</span>
<span class="co">#&gt; extent      : -373685.8, 370974.2, -604813.3, 449806.7  (xmin, xmax, ymin, ymax)</span>
<span class="co">#&gt; coord. ref. : +proj=aea +lat_0=0 +lon_0=-120 +lat_1=34 +lat_2=40.5 +x_0=0 +y_0=-4000000 +datum=NAD83 +units=m +no_defs </span>
<span class="co">#&gt; sources     : memory  </span>
<span class="co">#&gt;               memory  </span>
<span class="co">#&gt; names       :      meansup,      max_fpb </span>
<span class="co">#&gt; min values  : 0.0001474662, 0.0000000000 </span>
<span class="co">#&gt; max values  :    0.9972243,    1.0000000</span>

<span class="co"># Plot to see this layers</span>
<span class="va">ensemble_p_rst</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="va">ensemble_p</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">ensemble_p_rst</span><span class="op">)</span></code></pre></div>
<p><img src="03_post_modeling_files/figure-html/sdm_predict-3.png" width="576"></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># Predict an ensembles of small models.</span>
<span class="va">small_p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdm_predict.html">sdm_predict</a></span><span class="op">(</span>
  models <span class="op">=</span> <span class="va">msmall</span>,
  pred <span class="op">=</span> <span class="va">somevar</span>,
  thr <span class="op">=</span> <span class="st">"max_fpb"</span>,
  con_thr <span class="op">=</span> <span class="cn">FALSE</span>,
  predict_area <span class="op">=</span> <span class="cn">NULL</span>
<span class="op">)</span>
<span class="co">#&gt; Predicting ensemble of small models</span>

<span class="co"># Inspect the object It's a SpatRaster with 2 layers, msmall and max_fpb</span>
<span class="co"># These are the continuous and binary prediction from the ESM model</span>
<span class="va">small_p</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; class       : SpatRaster </span>
<span class="co">#&gt; dimensions  : 558, 394, 2  (nrow, ncol, nlyr)</span>
<span class="co">#&gt; resolution  : 1890, 1890  (x, y)</span>
<span class="co">#&gt; extent      : -373685.8, 370974.2, -604813.3, 449806.7  (xmin, xmax, ymin, ymax)</span>
<span class="co">#&gt; coord. ref. : +proj=aea +lat_0=0 +lon_0=-120 +lat_1=34 +lat_2=40.5 +x_0=0 +y_0=-4000000 +datum=NAD83 +units=m +no_defs </span>
<span class="co">#&gt; sources     : memory  </span>
<span class="co">#&gt;               memory  </span>
<span class="co">#&gt; names       :      esm_gam,      max_fpb </span>
<span class="co">#&gt; min values  : 2.049242e-05, 0.000000e+00 </span>
<span class="co">#&gt; max values  :    0.8722433,    1.0000000</span>

<span class="co"># Plot to see this layers</span>
<span class="va">small_p_rst</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="va">small_p</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">small_p_rst</span><span class="op">)</span></code></pre></div>
<p><img src="03_post_modeling_files/figure-html/sdm_predict-4.png" width="576"></p>
</div>
<div id="merge-model-performance-tables" class="section level3">
<h3 class="hasAnchor">
<a href="#merge-model-performance-tables" class="anchor"></a>2. Merge model performance tables</h3>
<p>This function combines model performance tables for all input models. This function requires a list of one or more models fitted with fit_ or tune_ functions, a fit_ensemble output, or a esm_ family function output.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Load abies data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">abies</span><span class="op">)</span>
<span class="va">abies</span>
<span class="co">#&gt; # A tibble: 1,400 x 13</span>
<span class="co">#&gt;       id pr_ab        x        y   aet   cwd  tmin ppt_djf ppt_jja    pH    awc</span>
<span class="co">#&gt;    &lt;int&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt;  1   715     0  -95417.  314240.  323.  546.  1.24    62.7   17.8   5.77 0.108 </span>
<span class="co">#&gt;  2  5680     0   98987. -159415.  448.  815.  9.43   130.     6.43  5.60 0.160 </span>
<span class="co">#&gt;  3  7907     0  121474.  -99463.  182.  271. -4.95   151.    11.2   0    0     </span>
<span class="co">#&gt;  4  1850     0  -39976.  -17456.  372.  946.  8.78   116.     2.70  6.41 0.0972</span>
<span class="co">#&gt;  5  1702     0  111372.  -91404.  209.  399. -4.03   165.     9.27  0    0     </span>
<span class="co">#&gt;  6 10036     0 -255715.  392229.  308.  535.  4.66   166.    16.5   5.70 0.0777</span>
<span class="co">#&gt;  7 12384     0 -311765.  380213.  568.  352.  4.38   480.    41.2   5.80 0.110 </span>
<span class="co">#&gt;  8  6513     0  111360. -120229.  327.  633.  4.93   163.     8.91  1.18 0.0116</span>
<span class="co">#&gt;  9  9884     0 -284326.  442136.  377.  446.  3.99   296.    16.8   5.96 0.0900</span>
<span class="co">#&gt; 10  8651     0  137640. -110538.  215.  265. -4.62   180.     9.57  0    0     </span>
<span class="co">#&gt; # ... with 1,390 more rows, and 2 more variables: depth &lt;dbl&gt;, landform &lt;fct&gt;</span>

<span class="co"># We will partition the data with the k-fold method</span>
<span class="va">abies2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/part_random.html">part_random</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">abies</span>,
  pr_ab <span class="op">=</span> <span class="st">"pr_ab"</span>,
  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"kfold"</span>, folds <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Build some models to use for the performance table merge</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Build a generalized additive model, and a generalized linear model using fit_ family functions</span>
<span class="va">gam_t1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_gam.html">fit_gam</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">abies2</span>,
  response <span class="op">=</span> <span class="st">"pr_ab"</span>,
  predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"aet"</span>, <span class="st">"ppt_jja"</span>, <span class="st">"pH"</span>, <span class="st">"awc"</span>, <span class="st">"depth"</span><span class="op">)</span>,
  predictors_f <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"landform"</span><span class="op">)</span>,
  partition <span class="op">=</span> <span class="st">".part"</span>,
  thr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"max_sens_spec"</span>, <span class="st">"equal_sens_spec"</span>, <span class="st">"max_sorensen"</span><span class="op">)</span>
<span class="op">)</span>
<span class="co">#&gt; Formula used for model fitting:</span>
<span class="co">#&gt; pr_ab ~ s(aet, k = -1) + s(ppt_jja, k = -1) + s(pH, k = -1) + s(awc, k = -1) + s(depth, k = -1) + landform</span>
<span class="co">#&gt; Replica number: 1/1</span>
<span class="co">#&gt; Partition number: 1/5</span>
<span class="co">#&gt; Partition number: 2/5</span>
<span class="co">#&gt; Partition number: 3/5</span>
<span class="co">#&gt; Partition number: 4/5</span>
<span class="co">#&gt; Partition number: 5/5</span>

<span class="va">glm_t1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_glm.html">fit_glm</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">abies2</span>,
  response <span class="op">=</span> <span class="st">"pr_ab"</span>,
  predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"aet"</span>, <span class="st">"ppt_jja"</span>, <span class="st">"pH"</span>, <span class="st">"awc"</span>, <span class="st">"depth"</span><span class="op">)</span>,
  predictors_f <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"landform"</span><span class="op">)</span>,
  partition <span class="op">=</span> <span class="st">".part"</span>,
  thr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"max_sens_spec"</span>, <span class="st">"equal_sens_spec"</span>, <span class="st">"max_sorensen"</span><span class="op">)</span>,
  poly <span class="op">=</span> <span class="fl">0</span>,
  inter_order <span class="op">=</span> <span class="fl">0</span>
<span class="op">)</span>
<span class="co">#&gt; Formula used for model fitting:</span>
<span class="co">#&gt; pr_ab ~ aet + ppt_jja + pH + awc + depth + landform</span>
<span class="co">#&gt; Replica number: 1/1</span>
<span class="co">#&gt; Partition number: 1/5</span>
<span class="co">#&gt; Partition number: 2/5</span>
<span class="co">#&gt; Partition number: 3/5</span>
<span class="co">#&gt; Partition number: 4/5</span>
<span class="co">#&gt; Partition number: 5/5</span>

<span class="co"># Build a tuned model using tune_ family functions</span>

<span class="co"># Prepare the grid object to use in grid argument</span>
<span class="va">tune_grid</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>mtry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">7</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Build a tuned random forest model</span>
<span class="va">rf_t1</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="../reference/tune_raf.html">tune_raf</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">abies2</span>,
    response <span class="op">=</span> <span class="st">"pr_ab"</span>,
    predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span>
      <span class="st">"aet"</span>, <span class="st">"cwd"</span>, <span class="st">"tmin"</span>, <span class="st">"ppt_djf"</span>,
      <span class="st">"ppt_jja"</span>, <span class="st">"pH"</span>, <span class="st">"awc"</span>, <span class="st">"depth"</span>
    <span class="op">)</span>,
    predictors_f <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"landform"</span><span class="op">)</span>,
    partition <span class="op">=</span> <span class="st">".part"</span>,
    grid <span class="op">=</span> <span class="va">tune_grid</span>,
    thr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"max_sens_spec"</span>, <span class="st">"equal_sens_spec"</span>, <span class="st">"max_sorensen"</span><span class="op">)</span>,
    metric <span class="op">=</span> <span class="st">"TSS"</span>,
  <span class="op">)</span>
<span class="co">#&gt; Formula used for model fitting:</span>
<span class="co">#&gt; pr_ab ~ aet + cwd + tmin + ppt_djf + ppt_jja + pH + awc + depth + landform</span>
<span class="co">#&gt; Replica number: 1/1</span>
<span class="co">#&gt; Formula used for model fitting:</span>
<span class="co">#&gt; pr_ab ~ aet + cwd + tmin + ppt_djf + ppt_jja + pH + awc + depth + landform</span>
<span class="co">#&gt; Replica number: 1/1</span>
<span class="co">#&gt; Partition number: 1/5</span>
<span class="co">#&gt; Partition number: 2/5</span>
<span class="co">#&gt; Partition number: 3/5</span>
<span class="co">#&gt; Partition number: 4/5</span>
<span class="co">#&gt; Partition number: 5/5</span></code></pre></div>
<p>(CAN YOU REMIND US WHY ARE THERE THREE THRESHOLD TYPES SPECIES FOR RAF MODEL BUILDING, BUT ONLY ONE IN THE MERGED TABLE? I THINK IT HAS TO DO WITH mwetric = “TSS” in tune_raf BUT IF I HAVE ALREADY FORGOTTEN, SO WILL OTHER USERS)</p>
<p>Finally, merge the three sdm performance tables.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">merge_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdm_summarize.html">sdm_summarize</a></span><span class="op">(</span>models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">gam_t1</span>, <span class="va">glm_t1</span>, <span class="va">rf_t1</span><span class="op">)</span><span class="op">)</span>

<span class="va">merge_df</span>
<span class="co">#&gt; # A tibble: 7 x 27</span>
<span class="co">#&gt;   model_ID model threshold      thr_value n_presences n_absences TPR_mean TPR_sd</span>
<span class="co">#&gt;      &lt;int&gt; &lt;chr&gt; &lt;chr&gt;              &lt;dbl&gt;       &lt;int&gt;      &lt;int&gt;    &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt; 1        1 gam   equal_sens_sp~     0.540         700        700    0.737 0.0366</span>
<span class="co">#&gt; 2        1 gam   max_sens_spec      0.530         700        700    0.751 0.0461</span>
<span class="co">#&gt; 3        1 gam   max_sorensen       0.359         700        700    0.864 0.0580</span>
<span class="co">#&gt; 4        2 glm   equal_sens_sp~     0.523         700        700    0.663 0.0583</span>
<span class="co">#&gt; 5        2 glm   max_sens_spec      0.463         700        700    0.803 0.111 </span>
<span class="co">#&gt; 6        2 glm   max_sorensen       0.356         700        700    0.876 0.0436</span>
<span class="co">#&gt; 7        3 raf   max_sens_spec      0.638         700        700    0.916 0.0430</span>
<span class="co">#&gt; # ... with 19 more variables: TNR_mean &lt;dbl&gt;, TNR_sd &lt;dbl&gt;,</span>
<span class="co">#&gt; #   SORENSEN_mean &lt;dbl&gt;, SORENSEN_sd &lt;dbl&gt;, JACCARD_mean &lt;dbl&gt;,</span>
<span class="co">#&gt; #   JACCARD_sd &lt;dbl&gt;, FPB_mean &lt;dbl&gt;, FPB_sd &lt;dbl&gt;, OR_mean &lt;dbl&gt;, OR_sd &lt;dbl&gt;,</span>
<span class="co">#&gt; #   TSS_mean &lt;dbl&gt;, TSS_sd &lt;dbl&gt;, AUC_mean &lt;dbl&gt;, AUC_sd &lt;dbl&gt;,</span>
<span class="co">#&gt; #   BOYCE_mean &lt;dbl&gt;, BOYCE_sd &lt;dbl&gt;, IMAE_mean &lt;dbl&gt;, IMAE_sd &lt;dbl&gt;,</span>
<span class="co">#&gt; #   mtry &lt;dbl&gt;</span></code></pre></div>
</div>
<div id="raster-interpolation-between-two-time-periods" class="section level3">
<h3 class="hasAnchor">
<a href="#raster-interpolation-between-two-time-periods" class="anchor"></a>3. Raster interpolation between two time periods</h3>
<p>This function is useful for calculating projected suitability values between two time periods with simple interpolation using two raster objects with suitability values. This is useful if, for example, a SDM has been projected to a future or past time period (using maps of predictor variables, such as climate variables, for different time periods), and the user requires an estimate of suitability for intermediate time periods. For example this may be needed for input into other types of models for risk analysis.</p>
<p>This function returns a SpatRaster if dir_save is used as NULL. However, if the user specifies dir_save, the function will save the interpolated raster files in a given directory.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/terra/">terra</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>

<span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"external/suit_time_step.tif"</span>, package <span class="op">=</span> <span class="st">"flexsdm"</span><span class="op">)</span>
<span class="va">abma</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">abma</span><span class="op">)</span></code></pre></div>
<p><img src="03_post_modeling_files/figure-html/interp_data-1.png" width="576"></p>
<p>This function will create an object of interpolated values with n annual layers ranging from the initial to final year. The resolution and dimensions of the result object will remain the same as the initial and final maps. In this example, there are nine annual (2011-2019) interpolated maps generated from the initial (2010) and final (2020) prediction maps. A cell with a starting value of 1 and and ending value of 0 would be changed in increments of (1-0)/((2020-2010)-1), and given interpolated values of 0.9, 0.8, 0.7…0.1</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">int</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/interp.html">interp</a></span><span class="op">(</span>
  r1 <span class="op">=</span> <span class="va">abma</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="co"># set the raster of initial year</span>
  r2 <span class="op">=</span> <span class="va">abma</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="co"># set the raster of final year</span>
  y1 <span class="op">=</span> <span class="fl">2010</span>, <span class="co"># set the numeric initial year</span>
  y2 <span class="op">=</span> <span class="fl">2020</span>, <span class="co"># set the numeric final year</span>
  rastername <span class="op">=</span> <span class="st">"Abies"</span>,
  dir_save <span class="op">=</span> <span class="cn">NULL</span>
<span class="op">)</span>

<span class="co"># Layers in the abma SpatRaster</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/names.html">names</a></span><span class="op">(</span><span class="va">abma</span><span class="op">)</span>
<span class="co">#&gt; [1] "current" "future"</span>
<span class="co"># plot(abma)</span>

<span class="co"># Layers in the int SpatRaster</span>
<span class="va">int</span>
<span class="co">#&gt; class       : SpatRaster </span>
<span class="co">#&gt; dimensions  : 558, 394, 11  (nrow, ncol, nlyr)</span>
<span class="co">#&gt; resolution  : 1890, 1890  (x, y)</span>
<span class="co">#&gt; extent      : -373685.8, 370974.2, -604813.3, 449806.7  (xmin, xmax, ymin, ymax)</span>
<span class="co">#&gt; coord. ref. : +proj=aea +lat_0=0 +lon_0=-120 +lat_1=34 +lat_2=40.5 +x_0=0 +y_0=-4000000 +datum=NAD83 +units=m +no_defs </span>
<span class="co">#&gt; sources     : memory  </span>
<span class="co">#&gt;               memory  </span>
<span class="co">#&gt;               memory  </span>
<span class="co">#&gt;               ... and 8 more source(s)</span>
<span class="co">#&gt; names       : Abies_2010, Abies_2011, Abies_2012, Abies_2013, Abies_2014, Abies_2015, ... </span>
<span class="co">#&gt; min values  :          0,          0,          0,          0,          0,          0, ... </span>
<span class="co">#&gt; max values  :  0.9756107,  0.9606077,  0.9504615,  0.9440073,  0.9442941,  0.9463548, ...</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">int</span><span class="op">)</span></code></pre></div>
<p><img src="03_post_modeling_files/figure-html/interp-1.png" width="576"></p>
</div>
<div id="measure-model-extrapolation" class="section level3">
<h3 class="hasAnchor">
<a href="#measure-model-extrapolation" class="anchor"></a>4. Measure model extrapolation</h3>
<p>This function measures the extent of model extrapolation by comparing data used for modeling calibration and the area for model projection using the approach proposed by Velazco et al., in prep.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/terra/">terra</a></span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">spp</span><span class="op">)</span>
<span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"external/somevar.tif"</span>, package <span class="op">=</span> <span class="st">"flexsdm"</span><span class="op">)</span>
<span class="va">somevar</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span>

<span class="co"># Inspect the unique values for species</span>
<span class="va">spp</span><span class="op">$</span><span class="va">species</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] "sp1" "sp2" "sp3"</span>

<span class="co"># Subset spp data into a tibble only with coordinates for sp3 and pr_ab == 1</span>
<span class="va">sp</span> <span class="op">&lt;-</span> <span class="va">spp</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="st">"sp3"</span>, <span class="va">pr_ab</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>

<span class="co"># Define accessible area for sp3 based on a buffer with around each point that is related to dispersal ability or some other ecological criterion</span>
<span class="va">ca</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calib_area.html">calib_area</a></span><span class="op">(</span><span class="va">sp</span>, x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span>, method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"buffer"</span>, width <span class="op">=</span> <span class="fl">30000</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Loading required namespace: rgeos</span>

<span class="co"># Plot the SpatRaster, occurrences and accessible area</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">somevar</span><span class="op">$</span><span class="va">CFP_1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/lines.html">points</a></span><span class="op">(</span><span class="va">sp</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">ca</span>, add <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></code></pre></div>
<p><img src="03_post_modeling_files/figure-html/measure_extrap-1.png" width="576"></p>
<p>The accessible area defines calibration area used to extract the environmental conditions</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">somevar_ca</span> <span class="op">&lt;-</span> <span class="va">somevar</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/terra/man/crop.html">crop</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">ca</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/terra/man/mask.html">mask</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">ca</span><span class="op">)</span>

<span class="co"># Plot environmental conditions of the calibration area</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">somevar_ca</span><span class="op">)</span></code></pre></div>
<p><img src="03_post_modeling_files/figure-html/get_env-1.png" width="576"></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">xp</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="../reference/extra_eval.html">extra_eval</a></span><span class="op">(</span>
    env_calib <span class="op">=</span> <span class="va">somevar_ca</span>,
    env_proj <span class="op">=</span> <span class="va">somevar</span>,
    n_cores <span class="op">=</span> <span class="fl">1</span>,
    aggreg_factor <span class="op">=</span> <span class="fl">3</span>
  <span class="op">)</span>

<span class="co"># Plot the SpatRaster object with the extrapolation values measured in percentage</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">xp</span><span class="op">)</span></code></pre></div>
<p><img src="03_post_modeling_files/figure-html/get_env-2.png" width="576"></p>
</div>
<div id="correction-of-suitability-based-on-extrapolation" class="section level3">
<h3 class="hasAnchor">
<a href="#correction-of-suitability-based-on-extrapolation" class="anchor"></a>5. Correction of suitability based on extrapolation</h3>
</div>
<div id="create-spatial-predictor-variables-to-reduce-overprediction-of-species-distribution-models" class="section level3">
<h3 class="hasAnchor">
<a href="#create-spatial-predictor-variables-to-reduce-overprediction-of-species-distribution-models" class="anchor"></a>6. Create spatial predictor variables to reduce overprediction of species distribution models</h3>
<p>This function creates geographical predictor variables that, together with environmental variables, can be used to construct constrained species distribution models. This function returns a SpatRaster object, which have to be used together with environmental variables to construct species distribution models. The ‘xy’ approach creates a single pair of raster layers that can be used for all species that share the same study region. Otherwise, ‘cml’, ‘min’, and ‘ker’ create a species-specific raster layer.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/terra/">terra</a></span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"spp"</span><span class="op">)</span>
<span class="va">somevar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"external/somevar.tif"</span>, package <span class="op">=</span> <span class="st">"flexsdm"</span><span class="op">)</span>
<span class="va">somevar</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="va">somevar</span><span class="op">)</span>

<span class="co"># Select the presences of one species (sp3)</span>
<span class="va">occ</span> <span class="op">&lt;-</span> <span class="va">spp</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="st">"sp3"</span>, <span class="va">pr_ab</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>

<span class="co"># Select a raster layer to be used as a basic raster</span>
<span class="va">a_variable</span> <span class="op">&lt;-</span> <span class="va">somevar</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">a_variable</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/lines.html">points</a></span><span class="op">(</span><span class="va">occ</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="03_post_modeling_files/figure-html/msdm_priori-1.png" width="576"></p>
<p>Next, use different methods according to your data.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Use xy method</span>
<span class="va">m_xy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msdm_priori.html">msdm_priori</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">occ</span>,
  x <span class="op">=</span> <span class="st">"x"</span>,
  y <span class="op">=</span> <span class="st">"y"</span>,
  method <span class="op">=</span> <span class="st">"xy"</span>,
  env_layer <span class="op">=</span> <span class="va">a_variable</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">m_xy</span><span class="op">)</span></code></pre></div>
<p><img src="03_post_modeling_files/figure-html/msdm_xy-1.png" width="576"></p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># Explore the object. This method assumes that spatial structure can partially explain species distribution (Bahn &amp; Mcgill, 2007). Therefore, the result are two raster layers containing the latitude and longitude of pixels, respectively. This method could be used for all species set that share the same study area region.</span>
<span class="va">m_xy</span>
<span class="co">#&gt; class       : SpatRaster </span>
<span class="co">#&gt; dimensions  : 558, 394, 2  (nrow, ncol, nlyr)</span>
<span class="co">#&gt; resolution  : 1890, 1890  (x, y)</span>
<span class="co">#&gt; extent      : -373685.8, 370974.2, -604813.3, 449806.7  (xmin, xmax, ymin, ymax)</span>
<span class="co">#&gt; coord. ref. : +proj=aea +lat_0=0 +lon_0=-120 +lat_1=34 +lat_2=40.5 +x_0=0 +y_0=-4000000 +datum=NAD83 +units=m +no_defs </span>
<span class="co">#&gt; sources     : memory  </span>
<span class="co">#&gt;               memory  </span>
<span class="co">#&gt; names       :  msdm_lon,  msdm_lat </span>
<span class="co">#&gt; min values  : -370850.8, -601978.3 </span>
<span class="co">#&gt; max values  :  368139.2,  448861.7</span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m_cml</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msdm_priori.html">msdm_priori</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">occ</span>,
  x <span class="op">=</span> <span class="st">"x"</span>,
  y <span class="op">=</span> <span class="st">"y"</span>,
  method <span class="op">=</span> <span class="st">"cml"</span>,
  env_layer <span class="op">=</span> <span class="va">a_variable</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">m_cml</span><span class="op">)</span></code></pre></div>
<p><img src="03_post_modeling_files/figure-html/msdm_cml-1.png" width="576"></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># Explore the object. This method assumes that pixels closer to presences are likely included in species distributions. The results is a raster layer containing the sum of euclidean geographic distances from each pixel to all occurrences of a species.</span>
<span class="va">m_cml</span>
<span class="co">#&gt; class       : SpatRaster </span>
<span class="co">#&gt; dimensions  : 558, 394, 1  (nrow, ncol, nlyr)</span>
<span class="co">#&gt; resolution  : 1890, 1890  (x, y)</span>
<span class="co">#&gt; extent      : -373685.8, 370974.2, -604813.3, 449806.7  (xmin, xmax, ymin, ymax)</span>
<span class="co">#&gt; coord. ref. : +proj=aea +lat_0=0 +lon_0=-120 +lat_1=34 +lat_2=40.5 +x_0=0 +y_0=-4000000 +datum=NAD83 +units=m +no_defs </span>
<span class="co">#&gt; source      : memory </span>
<span class="co">#&gt; name        : msdm_cml </span>
<span class="co">#&gt; min value   :        0 </span>
<span class="co">#&gt; max value   :        1</span></code></pre></div>
</div>
<div id="methods-to-correct-overprediction-of-species-distribution-models-based-on-occurrences-and-suitability-patterns" class="section level3">
<h3 class="hasAnchor">
<a href="#methods-to-correct-overprediction-of-species-distribution-models-based-on-occurrences-and-suitability-patterns" class="anchor"></a>7. Methods to correct overprediction of species distribution models based on occurrences and suitability patterns</h3>
<p>These methods are designed to reduce overprediction of species distribution models based on an a posteriori method (see Mendes et al 2020), i.e., the combination of the patterns of species occurrences and predicted suitability.</p>
<p>First, prepare the data</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/terra/">terra</a></span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"spp"</span><span class="op">)</span>
<span class="va">somevar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"external/somevar.tif"</span>, package <span class="op">=</span> <span class="st">"flexsdm"</span><span class="op">)</span>
<span class="va">somevar</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="va">somevar</span><span class="op">)</span>

<span class="co"># Prepare data for modeling a species</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="va">occ</span> <span class="op">&lt;-</span> <span class="va">spp</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="st">"sp2"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># filter using only sp2</span>
  <span class="fu"><a href="../reference/sdm_extract.html">sdm_extract</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">.</span>, x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span>,
    env_layer <span class="op">=</span> <span class="va">somevar</span>, filter_na <span class="op">=</span> <span class="cn">TRUE</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># extract variables values from the raster layer</span>
  <span class="fu"><a href="../reference/part_random.html">part_random</a></span><span class="op">(</span><span class="va">.</span>,
    pr_ab <span class="op">=</span> <span class="st">"pr_ab"</span>,
    method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"kfold"</span>, folds <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
  <span class="op">)</span> <span class="co"># add columns with partition</span>
<span class="co">#&gt; 6 rows were excluded from database because NAs were found</span></code></pre></div>
<p>Next, we fit and predict a model</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m_glm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_glm.html">fit_glm</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">occ</span>,
  response <span class="op">=</span> <span class="st">"pr_ab"</span>,
  predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/names.html">names</a></span><span class="op">(</span><span class="va">somevar</span><span class="op">)</span>,
  partition <span class="op">=</span> <span class="st">".part"</span>,
  thr <span class="op">=</span> <span class="st">"equal_sens_spec"</span>,
<span class="op">)</span>
<span class="co">#&gt; Formula used for model fitting:</span>
<span class="co">#&gt; pr_ab ~ CFP_1 + CFP_2 + CFP_3 + CFP_4</span>
<span class="co">#&gt; Replica number: 1/1</span>
<span class="co">#&gt; Partition number: 1/10</span>
<span class="co">#&gt; Partition number: 2/10</span>
<span class="co">#&gt; Partition number: 3/10</span>
<span class="co">#&gt; Partition number: 4/10</span>
<span class="co">#&gt; Partition number: 5/10</span>
<span class="co">#&gt; Partition number: 6/10</span>
<span class="co">#&gt; Partition number: 7/10</span>
<span class="co">#&gt; Partition number: 8/10</span>
<span class="co">#&gt; Partition number: 9/10</span>
<span class="co">#&gt; Partition number: 10/10</span></code></pre></div>
<p>Next, let’s predict this model and plot it in a map</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Predict this model</span>
<span class="va">m_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdm_predict.html">sdm_predict</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">m_glm</span>, pred <span class="op">=</span> <span class="va">somevar</span>, thr <span class="op">=</span> <span class="cn">NULL</span>, con_thr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; Predicting individual models</span>

<span class="co"># Predicting individual models</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">m_pred</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p><img src="03_post_modeling_files/figure-html/msdm_post_predict-1.png" width="576"></p>
<p>Finally, perform correction to avoid models overpredictions.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Using mcp method. The Minimum Convex Polygon (mcp) method excludes from SDMs climate suitable pixels that do not intercept a minimum convex polygon, with interior angles smaller than 180, enclosing all occurrences of a species.</span>
<span class="va">m_mcp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msdm_posteriori.html">msdm_posteriori</a></span><span class="op">(</span>
  records <span class="op">=</span> <span class="va">occ</span>,
  x <span class="op">=</span> <span class="st">"x"</span>,
  y <span class="op">=</span> <span class="st">"y"</span>,
  pr_ab <span class="op">=</span> <span class="st">"pr_ab"</span>,
  method <span class="op">=</span> <span class="st">"mcp"</span>,
  cont_suit <span class="op">=</span> <span class="va">m_pred</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,
  thr <span class="op">=</span> <span class="st">"equal_sens_spec"</span>,
  buffer <span class="op">=</span> <span class="cn">NULL</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">m_mcp</span><span class="op">)</span></code></pre></div>
<p><img src="03_post_modeling_files/figure-html/msdm_post-1.png" width="576"></p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># Using bmcp method. The Buffered Minimum Convex Polygon (bmcp) method is similar to the 'mcp' except by the inclusion of a buffer zone surrounding minimum convex polygons.</span>
<span class="va">m_bmcp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msdm_posteriori.html">msdm_posteriori</a></span><span class="op">(</span>
  records <span class="op">=</span> <span class="va">occ</span>,
  x <span class="op">=</span> <span class="st">"x"</span>,
  y <span class="op">=</span> <span class="st">"y"</span>,
  pr_ab <span class="op">=</span> <span class="st">"pr_ab"</span>,
  method <span class="op">=</span> <span class="st">"bmcp"</span>,
  cont_suit <span class="op">=</span> <span class="va">m_pred</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,
  thr <span class="op">=</span> <span class="st">"equal_sens_spec"</span>,
  buffer <span class="op">=</span> <span class="fl">30000</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">m_bmcp</span><span class="op">)</span></code></pre></div>
<p><img src="03_post_modeling_files/figure-html/msdm_post-2.png" width="576"></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># Using obr method. The Occurrences Based Restriction (obr) method assumes that suitable patches intercepting species occurrences are more likely a part of species distributions than suitable patches that do not intercept any occurrence.</span>
<span class="va">m_obr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msdm_posteriori.html">msdm_posteriori</a></span><span class="op">(</span>
  records <span class="op">=</span> <span class="va">occ</span>,
  x <span class="op">=</span> <span class="st">"x"</span>,
  y <span class="op">=</span> <span class="st">"y"</span>,
  pr_ab <span class="op">=</span> <span class="st">"pr_ab"</span>,
  method <span class="op">=</span> <span class="st">"obr"</span>,
  cont_suit <span class="op">=</span> <span class="va">m_pred</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,
  thr <span class="op">=</span> <span class="st">"equal_sens_spec"</span>,
  buffer <span class="op">=</span> <span class="cn">NULL</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">m_obr</span><span class="op">)</span></code></pre></div>
<p><img src="03_post_modeling_files/figure-html/msdm_post-3.png" width="576"></p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># Using pres method. The only occurrences based restriction (pres) method only retains those pixels in suitability patches intercepting occurrences.</span>
<span class="va">m_pres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msdm_posteriori.html">msdm_posteriori</a></span><span class="op">(</span>
  records <span class="op">=</span> <span class="va">occ</span>,
  x <span class="op">=</span> <span class="st">"x"</span>,
  y <span class="op">=</span> <span class="st">"y"</span>,
  pr_ab <span class="op">=</span> <span class="st">"pr_ab"</span>,
  method <span class="op">=</span> <span class="st">"pres"</span>,
  cont_suit <span class="op">=</span> <span class="va">m_pred</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,
  thr <span class="op">=</span> <span class="st">"equal_sens_spec"</span>,
  buffer <span class="op">=</span> <span class="cn">NULL</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">m_pres</span><span class="op">)</span></code></pre></div>
<p><img src="03_post_modeling_files/figure-html/msdm_post-4.png" width="576"></p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># Using lq method. The Lower Quantile (lq) method works whenever a suitable pixel is within a k patch, i.e., not within this lower quartile, the suitability of the pixel is reduced to zero. This means that 75% of k patches were withdrawn from the model.</span>
<span class="va">m_lq</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msdm_posteriori.html">msdm_posteriori</a></span><span class="op">(</span>
  records <span class="op">=</span> <span class="va">occ</span>,
  x <span class="op">=</span> <span class="st">"x"</span>,
  y <span class="op">=</span> <span class="st">"y"</span>,
  pr_ab <span class="op">=</span> <span class="st">"pr_ab"</span>,
  method <span class="op">=</span> <span class="st">"lq"</span>,
  cont_suit <span class="op">=</span> <span class="va">m_pred</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,
  thr <span class="op">=</span> <span class="st">"equal_sens_spec"</span>,
  buffer <span class="op">=</span> <span class="cn">NULL</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">m_lq</span><span class="op">)</span></code></pre></div>
<p><img src="03_post_modeling_files/figure-html/msdm_post-5.png" width="576"></p>
<p>#=========#=========#=========#=========#=========#=========#=========#</p>
<p><strong>Vignette still under construction and changes</strong></p>
<p>#=========#=========#=========#=========#=========#=========#=========#</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Santiago J.E. Velazco, Brooke Rose, André F.A. Andrade, Ignacio Minoli, Janet Franklin.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
